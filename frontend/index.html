<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Web Tuy·ªÉn D·ª•ng Chuy√™n Nghi·ªáp</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />

  <style>
    /* üåà T·ªïng th·ªÉ */
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #f0f6ff, #eaf3ff);
      color: #333;
    }

    /* üîπ Header */
    header {
      background: linear-gradient(90deg, #1e3a8a, #2563eb);
      color: white;
      padding: 15px 30px;
      position: fixed;
      top: 0; left: 0; right: 0;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }

    header h1 {
      margin: 0;
      font-weight: 600;
      letter-spacing: 1px;
    }

    nav ul {
      list-style: none;
      display: flex;
      gap: 20px;
      margin: 0;
      padding: 0;
    }

    nav ul li a {
      color: white;
      text-decoration: none;
      font-weight: 500;
      transition: color 0.3s;
    }

    nav ul li a:hover {
      color: #00d4ff;
    }

    /* üî∏ N√∫t ƒëƒÉng nh·∫≠p / ƒëƒÉng k√Ω / ƒëƒÉng xu·∫•t */
    .auth-buttons {
      display: flex;
      gap: 10px;
    }

    .auth-buttons button {
      padding: 8px 14px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 500;
      background: linear-gradient(90deg, #00b4d8, #48cae4);
      color: white;
      transition: all 0.3s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .auth-buttons button:hover {
      transform: scale(1.05);
      background: linear-gradient(90deg, #48cae4, #00b4d8);
    }

    /* üèû Hero banner */
    .hero {
      background:
        linear-gradient(rgba(30,58,138,0.6), rgba(30,58,138,0.6)),
        url('https://images.unsplash.com/photo-1556761175-5973dc0f32e7?auto=format&fit=crop&w=1600&q=80')
        center/cover no-repeat;
      height: 380px;
      display: flex;
      justify-content: center;
      align-items: center;
      text-align: center;
      color: white;
      margin-top: 70px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    }

    .hero h2 {
      font-size: 34px;
      font-weight: 600;
      max-width: 700px;
      line-height: 1.4;
    }

    /* üîç √î t√¨m ki·∫øm v√† l∆∞·ªõi c√¥ng vi·ªác */
    main {
      margin-top: 40px;
      padding: 20px;
      max-width: 1200px;
      margin-inline: auto;
    }

    #searchBox {
      width: 100%;
      padding: 14px 16px;
      border-radius: 10px;
      border: 1px solid #cbd5e1;
      font-size: 16px;
      margin-bottom: 25px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.05);
      transition: all 0.3s;
    }

    #searchBox:focus {
      border-color: #2563eb;
      outline: none;
      box-shadow: 0 4px 12px rgba(37,99,235,0.15);
    }

    #job-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 25px;
    }

    .job-card {
      background: white;
      border-radius: 14px;
      box-shadow: 0 4px 14px rgba(0,0,0,0.08);
      padding: 20px;
      transition: all 0.3s ease;
      cursor: pointer;
      text-align: center;
      border: 1px solid transparent;
    }

    .job-card:hover {
      transform: translateY(-6px);
      border: 1px solid #2563eb;
      box-shadow: 0 8px 20px rgba(37,99,235,0.2);
    }

    .job-card img {
      width: 100%;
      max-width: 150px;
      height: 150px;
      object-fit: cover;
      border-radius: 10px;
      margin-bottom: 10px;
    }

    .job-card h3 {
      font-size: 18px;
      color: #1e3a8a;
      font-weight: 600;
    }

    /* ü™ü Popup */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      animation: fadeIn 0.3s;
      backdrop-filter: blur(4px);
    }

    .modal-content {
      background: white;
      padding: 25px 30px;
      border-radius: 14px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.25);
      animation: popIn 0.3s;
      position: relative;
    }

    .close-btn {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 26px;
      cursor: pointer;
      color: #555;
      transition: color 0.2s;
    }

    .close-btn:hover { color: #000; }

    /* ‚úÖ N√∫t ·ª®ng tuy·ªÉn */
    .modal-content button {
      background: linear-gradient(90deg, #16a34a, #22c55e);
      color: white;
      border: none;
      border-radius: 10px;
      padding: 12px 22px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 15px;
      transition: all 0.25s ease;
      box-shadow: 0 4px 10px rgba(22, 163, 74, 0.3);
    }

    .modal-content button:hover {
      background: linear-gradient(90deg, #22c55e, #16a34a);
      transform: translateY(-2px);
      box-shadow: 0 6px 14px rgba(22, 163, 74, 0.4);
    }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes popIn { from { transform: scale(0.9); } to { transform: scale(1); } }

    /* üì± Responsive */
    @media (max-width: 768px) {
      .hero h2 { font-size: 24px; }
      .job-card img { max-width: 120px; height: 120px; }
      header { flex-direction: column; gap: 10px; text-align: center; }
    }
  </style>
</head>

<body>
  <header>
    <h1>üåê Web Tuy·ªÉn D·ª•ng</h1>
    <nav>
      <ul>
        <li><a href="#" onclick="showPage('home')">Trang Ch√≠nh</a></li>
        <li><a href="#" onclick="showPage('myApplications')">ƒê√£ ·ª®ng Tuy·ªÉn</a></li>
      </ul>
    </nav>
    <div class="auth-buttons">
      <button id="loginBtn" onclick="window.location.href='user_login.html'">ƒêƒÉng nh·∫≠p</button>
      <button id="registerBtn" onclick="window.location.href='user_register.html'">ƒêƒÉng k√Ω</button>
      <button id="logoutBtn" style="display:none;" onclick="logout()">ƒêƒÉng xu·∫•t</button>
    </div>
  </header>

  <section class="hero">
    <h2>T√¨m vi·ªác l√†m m∆° ∆∞·ªõc c·ªßa b·∫°n t·∫°i ƒë√¢y</h2>
  </section>

  <main>
    <!-- Trang ch√≠nh -->
    <section id="home" class="page active">
      <input type="text" id="searchBox" placeholder="üîç T√¨m c√¥ng ty..." oninput="filterJobs()" />
      <p id="loading">ƒêang t·∫£i d·ªØ li·ªáu...</p>
      <div id="job-list"></div>
    </section>

    <!-- Trang ƒë√£ ·ª©ng tuy·ªÉn -->
    <section id="myApplications" class="page" style="display:none;">
      <h2 style="text-align:center; margin-bottom: 20px;">üíº C√¥ng ty b·∫°n ƒë√£ ·ª©ng tuy·ªÉn</h2>
      <div id="applied-list" class="job-list"></div>
      <p id="noApplications" style="text-align:center; display:none;">B·∫°n ch∆∞a ·ª©ng tuy·ªÉn c√¥ng ty n√†o.</p>
    </section>
  </main>

  <script>
    const API_URL = "http://localhost:3000/api/jobs";
    const CACHE_EXPIRE = 5 * 60 * 1000;
    let jobs = [];
    const safeValue = v => (!v || String(v).trim() === "" ? "ƒêang c·∫≠p nh·∫≠t" : v);

    /* ==================== HI·ªÇN TH·ªä / ·∫®N PAGE ==================== */
    function showPage(id) {
      document.querySelectorAll(".page").forEach(p => p.style.display = "none");
      document.getElementById(id).style.display = "block";
      if (id === "myApplications") fetchUserApplications();
    }

    /* ==================== HI·ªÇN TH·ªä DANH S√ÅCH JOB ==================== */
    function renderJobs(list = jobs) {
      const jobList = document.getElementById("job-list");
      const loading = document.getElementById("loading");
      jobList.innerHTML = "";
      loading.style.display = "none";

      list.forEach((job, i) => {
        jobList.innerHTML += `
          <div class="job-card" onclick="showJobDetail(${i})">
            <img src="${safeValue(job.image || 'https://via.placeholder.com/120')}" alt="${safeValue(job.company)}" />
            <h3>${safeValue(job.company)}</h3>
          </div>`;
      });
    }

    function filterJobs() {
      const kw = document.getElementById("searchBox").value.toLowerCase();
      renderJobs(jobs.filter(j => j.company.toLowerCase().includes(kw)));
    }

    /* ==================== MODAL CHI TI·∫æT JOB ==================== */
    function showJobDetail(i) {
      const j = jobs[i];
      const modal = document.createElement("div");
      modal.className = "modal-overlay";
      modal.innerHTML = `
        <div class="modal-content">
          <span class="close-btn" onclick="this.closest('.modal-overlay').remove()">&times;</span>
          <h2>${safeValue(j.company)}</h2>
          <img src="${safeValue(j.image || 'https://via.placeholder.com/150')}" alt="${safeValue(j.company)}"
               style="width:150px;height:150px;object-fit:cover;border-radius:10px;margin:10px 0;">
          <p><b>Lo·∫°i h√¨nh:</b> ${safeValue(j.type)}</p>
          <p><b>ƒê·ªãa ch·ªâ:</b> ${safeValue(j.address)}</p>
          <p><b>L∆∞∆°ng:</b> ${safeValue(j.salary)}</p>
          <p><b>ƒê·ªô tu·ªïi:</b> ${safeValue(j.age)}</p>
          <p><b>Chi ti·∫øt c√¥ng vi·ªác:</b> ${safeValue(j.detail)}</p>
          <button onclick="applyJob(${i})">·ª®ng tuy·ªÉn ngay</button>
        </div>`;
      document.body.appendChild(modal);
    }

    /* ==================== FETCH JOBS ==================== */
    async function fetchJobs() {
      try {
        const res = await fetch(API_URL);
        const data = await res.json();
        localStorage.setItem("cachedJobs", JSON.stringify({ timestamp: Date.now(), jobs: data }));
        jobs = data;
        renderJobs();
      } catch (err) {
        console.error("L·ªói fetch jobs:", err);
      }
    }

    function initJobs() {
      const cached = localStorage.getItem("cachedJobs");
      if (cached) {
        const { timestamp, jobs: cJobs } = JSON.parse(cached);
        if (Date.now() - timestamp < CACHE_EXPIRE) {
          jobs = cJobs;
          renderJobs();
        }
      }
      fetchJobs();
    }

    /* ==================== APPLY JOB ==================== */
    async function applyJob(index) {
  try {
    const resAuth = await fetch("http://localhost:3000/api/check-auth", { credentials: "include" });
    const authData = await resAuth.json();

    if (!authData?.loggedIn) {
      alert("Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi ·ª©ng tuy·ªÉn!");
      window.location.href = "user_login.html";
      return;
    }

    const job = jobs[index];
    const user = authData.user;

    // ‚úÖ L∆∞u t·∫°m v√†o localStorage ƒë·ªÉ form.html d√πng l·∫°i
    localStorage.setItem("selectedJob", JSON.stringify(job));
    localStorage.setItem("currentUser", JSON.stringify(user));

    // ‚úÖ Chuy·ªÉn sang form.html ƒë·ªÉ ƒëi·ªÅn th√¥ng tin
    window.location.href = "form.html";
  } catch (err) {
    console.error("‚ùå L·ªói khi ·ª©ng tuy·ªÉn:", err);
    alert("ƒê√£ c√≥ l·ªói x·∫£y ra, th·ª≠ l·∫°i sau!");
  }
}

    /* ==================== FETCH DANH S√ÅCH ·ª®NG TUY·ªÇN ==================== */
    async function fetchUserApplications() {
      try {
        const resAuth = await fetch("http://localhost:3000/api/check-auth", { credentials: "include" });
        const authData = await resAuth.json();

        if (!authData.loggedIn) {
          alert("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ xem danh s√°ch ·ª©ng tuy·ªÉn!");
          window.location.href = "user_login.html";
          return;
        }

        const res = await fetch(`http://localhost:3000/api/user/${authData.user.id}/applications`);
        const data = await res.json();
        const container = document.getElementById("applied-list");
        const noApp = document.getElementById("noApplications");

        container.innerHTML = "";
        if (data.length === 0) {
          noApp.style.display = "block";
          return;
        }

        noApp.style.display = "none";
        data.forEach(c => {
          container.innerHTML += `
            <div class="job-card">
              <img src="${c.image || 'https://via.placeholder.com/150'}" alt="${c.company}" />
              <h3>${c.company}</h3>
              <p><b>ƒê·ªãa ch·ªâ:</b> ${c.address || "Ch∆∞a c·∫≠p nh·∫≠t"}</p>
              <p><b>L∆∞∆°ng:</b> ${c.salary || "Th·ªèa thu·∫≠n"}</p>
              <p><i>·ª®ng tuy·ªÉn l√∫c:</i> ${new Date(c.applied_at).toLocaleString()}</p>
            </div>`;
        });
      } catch (err) {
        console.error("‚ùå L·ªói khi t·∫£i danh s√°ch ·ª©ng tuy·ªÉn:", err);
      }
    }

    /* ==================== AUTH + LOGOUT ==================== */
    async function checkAuth() {
      try {
        const res = await fetch("http://localhost:3000/api/check-auth", { credentials: "include" });
        const data = await res.json();

        const loginBtn = document.getElementById("loginBtn");
        const registerBtn = document.getElementById("registerBtn");
        const logoutBtn = document.getElementById("logoutBtn");

        if (data.loggedIn) {
          loginBtn.style.display = "none";
          registerBtn.style.display = "none";
          logoutBtn.style.display = "inline-block";
          localStorage.setItem("user", JSON.stringify(data.user));
        } else {
          loginBtn.style.display = "inline-block";
          registerBtn.style.display = "inline-block";
          logoutBtn.style.display = "none";
          localStorage.removeItem("user");
        }
      } catch (err) {
        console.error("L·ªói ki·ªÉm tra session:", err);
      }
    }

    async function logout() {
      try {
        await fetch("http://localhost:3000/api/logout", { method: "POST", credentials: "include" });
        localStorage.removeItem("user");
        alert("B·∫°n ƒë√£ ƒëƒÉng xu·∫•t!");
        checkAuth();
        showPage("home");
      } catch (err) {
        console.error("L·ªói logout:", err);
      }
    }

    /* ==================== KH·ªûI T·∫†O ==================== */
    initJobs();
    checkAuth();
  </script>
</body>
</html>
